<%
        var config = {};
        var db = session.get("db");
        if(db==null){
            db = new Database("jdbc:mysql://localhost:3306/bamwebappstats?autoReconnect=true", "root", "root123", config);
            session.put("db",db);
        }

        var maxResultCount =2147483647;
        var query ="";
    	var action = request.getParameter("action");
    	var limit = request.getParameter("limit");
    	if(limit==null){
    	    limit = maxResultCount;
    	}
    	if(action=="getTopPlatformApps"){
            query = "select concat(appName,' Of ' appOwnerTenant) as appName, sum(total_request_count) as requests from WEBAPP_REQUEST_SUMMARY group by appName,appOwnerTenant order by requests desc limit " + limit;
    	}else if(action=="getTopSolutionProviders"){
            query = "select appOwnerTenant, sum(total_request_count) as requests from WEBAPP_REQUEST_SUMMARY group by appOwnerTenant order by requests desc limit " + limit;
    	} if(action=="getTopConsumers"){
            query = "select userTenant, sum(total_request_count) as requests from WEBAPP_REQUEST_SUMMARY group by userTenant order by requests desc limit " + limit;
    	}if(action=="getTopConsumerUsers"){
            query = "select userId, sum(total_request_count) as requests from WEBAPP_REQUEST_SUMMARY group by userId order by requests desc limit " + limit;
    	}


        var result = db.query(query);
        var respJson = null;

        function createTableJSON(result) {
            var len = result.length;
            var rows = [];
            var columnNames = []
            for (var i = 0; i < len; i++) {
                var obj = result[i];
                var row = []
                for(var k in obj) {
                    if ({}.hasOwnProperty.call(obj, k)) {
                        if (i == 0) {
                            columnNames.push(k);
                        }
                        row.push(obj[k]);
                    }
                }
                rows.push(row);
            }
            return {Rows: rows, ColumnNames : columnNames};
        }

        respJson = createTableJSON(result);
    

        print(respJson);
   		 %>
