<?xml version="1.0" encoding="ISO-8859-1"?>

<!--
  ~  Copyright (c) 2005-2008, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
  ~
  ~  WSO2 Inc. licenses this file to you under the Apache License,
  ~  Version 2.0 (the "License"); you may not use this file except
  ~  in compliance with the License.
  ~  You may obtain a copy of the License at
  ~
  ~    http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing,
  ~  software distributed under the License is distributed on an
  ~  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~  KIND, either express or implied.  See the License for the
  ~  specific language governing permissions and limitations
  ~  under the License.
  ~
  -->

<!DOCTYPE html
   PUBLIC "-//W3C//DTD XHTML 1.1//EN"
   "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd" >

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=iso-8859-1"/>
    <title>
      WSO2 Governance Registry - Setting up Database - H2
    </title>
    <link href="../css/greg-docs.css" rel="stylesheet"/>
    <link href="../styles/dist-docs.css" rel="stylesheet" type="text/css" media="all"/>
  </head>
  <body xml:lang="en">
[ <a href="../docs_index.html"> Documentation Index </a> ]
<h1>WSO2 Governance Registry - Setting up with H2 Database (Embedded and Remote)</h1>
<h2>Table of Contents</h2>

<ul>
<li>
<a href="#remote">Setting up Database - Remote H2</a>

<ul>
<li>
<a href="#prepare_remote">Preparing the Remote H2 Database</a>
</li>
<li>
<a href="#conf_remote">Setup Configuration Files</a>
</li>
<li>
<a href="#drivers_remote">Setup Drivers</a>
</li>
<li>
<a href="#createdb_remote">Create Database</a>

<ul>
<li>
<a href="#autodb_remote">Automatic Database Creation</a>
</li>
<li>
<a href="#manualdb_remote">Manual Database Creation</a>
</li>
</ul>
</li>
</ul>
</li>

<li>
<a href="#embedded">Setting up Database - H2 Embedded</a>

<ul>
<li>
<a href="#prepare_embedded">Preparing the Embedded H2 Database</a>
</li>
<li>
<a href="#conf_embedded">Setup Configuration Files</a>
</li>
<li>
<a href="#drivers_embedded">Setup Drivers</a>
</li>
<li>
<a href="#createdb_embedded">Create Database</a>

<ul>
<li>
<a href="#autodb_embedded">Automatic Database Creation</a>
</li>
<li>
<a href="#manualdb_embedded">Manual Database Creation</a>
</li>
</ul>
</li>
</ul>

</li>

</ul>

<h1>Setting up with remote H2 Database</h1>


<h2 id="prepare_remote">Preparing the remote H2 DB.</h2>

<p>
Below are the steps for configuring WSO2 Governance Registry with H2 remote database.
</p>
<ol>
<li> Download and install H2 DB in you computer, if it is not already done. You can find H2 installation guide from <a href="http://www.h2database.com/html/quickstart.html">here</a>.
</li>
<li>Go to the $H2_HOME/bin directory and run the h2 network server starting script. $H2_HOME is the installation directory of H2</li>
<li><p>Run H2 database server with following commands.</p>
        <p>
          $ ./h2.sh
        </p>
        <p>
          $  h2.bat
        </p>
        <p>
            The script will start the database engine and bring up a pop up window with start browse button.
            "Start Browser" button will open a web browser containing a client application using which you can connect to a database.
            h2 will automatically create a database, if a database does not exist by the name you provide in the 'JDBC URL' text box.
        </p>
 </li>

</ol>

<h2 id="conf_remote">Setup Configuration Files</h2>
<ol>
<li>
<p>
    Edit the $GREG_HOME/repository/conf/registry.xml file, where GREG_HOME is the installation directory of the registry distribution.
          Note the highlighted configurations, you
          may use your own database name, username and password </p>

<pre>
    &lt;currentDBConfig&gt;h2-db&lt;/currentDBConfig&gt;
    &lt;dbConfig name="h2-db"&gt;
        &lt;url&gt;<strong>jdbc:h2:tcp://localhost/~/registryDB;create=true;LOCK_TIMEOUT=60000</strong>&lt;/url&gt;
        &lt;userName&gt;<strong>regadmin</strong>&lt;/userName&gt;
        &lt;password&gt;<strong>regadmin</strong>&lt;/password&gt;
        &lt;driverName&gt;<strong>org.h2.Driver</strong>&lt;/driverName&gt;
        &lt;maxActive&gt;<strong>80</strong>&lt;/maxActive&gt;
        &lt;maxWait&gt;<strong>60000</strong>&lt;/maxWait&gt;
        &lt;minIdle&gt;<strong>5</strong>&lt;/minIdle&gt;
    &lt;/dbConfig&gt;
</pre>
<p>
Explanation of the database configuration options.
</p>
<ul>
<li>
url: The URL of the database</li>
<li>
userName: The name of the database user</li>
<li>
password: The password of the database user</li>
<li>
driverName: The class name of the database driver</li>
<li>
maxActive: The maximum number of active connections that can be allocated from this pool at the same time, or negative for no limit.
</li>
<li>
maxWait: The maximum number of milliseconds that the pool will wait (when there
    are no available connections) for a connection to be returned before throwing an
    exception, or &lt;= 0 to wait indefinitely. </li>
<li>
minIdle: The minimum number of active connections that can remain idle in the
    pool, without extra ones being created, or 0 to create none. </li>
</ul>

</li>
  <li>
    <p>
      Edit the  $GREG_HOME/repository/conf/user-mgt.xml file as below
      (Note that you have to replace these settings with your custom values).
    </p>

<pre>
    &lt;Configuration&gt;
        ...
        &lt;Property name="url"&gt;<strong>jdbc:h2:tcp://localhost/~/registryDB;create=true</strong>&lt;/Property&gt;
        &lt;Property name="userName"&gt;<strong>regadmin</strong>&lt;/Property&gt;
        &lt;Property name="password"&gt;<strong>regadmin</strong>&lt;/Property&gt;
        &lt;Property name="driverName"&gt;<strong>org.h2.Driver</strong>&lt;/Property&gt;
        &lt;Property name="maxActive"&gt;<strong>50</strong>&lt;/Property&gt;
        &lt;Property name="maxWait"&gt;<strong>60000</strong>&lt;/Property&gt;
        &lt;Property name="minIdle"&gt;<strong>5</strong>&lt;/Property&gt;
    &lt;/Configuration&gt;
</pre>
  </li>
</ol>

<h2 id="drivers_remote">Setup Drivers</h2>
Presently, H2 database version h2-1.2.140 and the related H2 database driver is shipped with WSO2 Governance Registry. If you wish to use a new H2 database driver other than the version shipped with the WSO2 Governance Registry, you need to do the following.
<ol>

    <li>
        <p>
	Delete H2 database related jars shipped with WSO2 Governance Registry. One could find them in the following locations.
	<pre>
    $GREG_HOME/repository/components/plugins/h2-database-engine-1.2.140.wso2v2.jar
    $GREG_HOME/repository/components/configuration/org.eclipse.osgi/bundles/38/1/.cp/h2-1.2.140.jar
    $GREG_HOME/repository/lib/h2-1.2.140.jar
    $GREG_HOME/lib/h2-database-engine-1.2.140.wso2v2.jar
	</pre>
        </p>
    </li>
    <li>  
        <p>
        Copy the new H2 database driver (org.h2.Driver) to $GREG_HOME/repository/components/lib. One could find the required driver jar in $H2_HOME/bin/h2-*.jar
    	</p>
        <p>
          <b>Note: </b>Remove old database driver from $GREG_HOME/repository/components/dropins ,when you upgrade the database driver.
        </p>
   </li>
</ol>

<h2 id="createdb_remote">Create Database</h2>
<h3 id="autodb_remote">Automatic Database Creation</h3>
    <ol>
      <li>
        <p>
          Next at the first time you start the registry, run with the -Dsetup option, so
          it will create the H2 database with all the underlying tables.
        </p>

        <p>
          sh wso2server.sh -Dsetup
        </p>
        <p>
         wso2server.bat -Dsetup
        </p>
      </li>
 </ol>

<h3 id="manualdb_remote"> Manual Table Creation using scripts</h3>


<ol>
    <li><p>Tables can be manually created by logging into created database and running  and following script in H2 shell or web console.</p>

    <p>
        GREG_HOME/dbscripts/h2.sql
    </p>

    </li>
    <li>
        After setting up the registry DB tables,start the server with below commands.

        <p>
           sh wso2server.sh
        </p>
        <p>
           wso2server.bat
    </p>
    </li>

</ol>

<h1 id="embedded">Setting up with embedded H2 Database</h1>

<h2 id="prepare_embedded">Preparing the Embedded H2 Database</h2>

      <p>
      Below are the steps for configuring WSO2 Governance Registry with H2 embedded database.
      </p>
      <ol>
      <li> Download and install H2 DB in you computer, if it is not already done. You can find H2 installation guide from <a href="http://www.h2database.com/html/quickstart.html">here</a>.
      </li>

      </ol>

      <h2 id="conf_embedded">Setup configuration Files</h2>
      <ol>
      <li>
      <p>
          Edit the $GREG_HOME/repository/conf/registry.xml file, where GREG_HOME is the installation directory of the registry distribution.
          Note the highlighted configurations, you
          may use your own database name, username and password. </p>

<pre>
    &lt;currentDBConfig&gt;h2-db&lt;/currentDBConfig&gt;
    &lt;dbConfig name="h2-db"&gt;
        &lt;url&gt;<strong>jdbc:h2:repository/database/WSO2CARBON_DB;DB_CLOSE_ON_EXIT=FALSE;LOCK_TIMEOUT=60000</strong>&lt;/url&gt;
        &lt;userName&gt;<strong>wso2carbon</strong>&lt;/userName&gt;
        &lt;password&gt;<strong>wso2carbon</strong>&lt;/password&gt;
        &lt;driverName&gt;<strong>org.h2.Driver</strong>&lt;/driverName&gt;
        &lt;maxActive&gt;<strong>50</strong>&lt;/maxActive&gt;
        &lt;maxWait&gt;<strong>60000</strong>&lt;/maxWait&gt;
        &lt;minIdle&gt;<strong>5</strong>&lt;/minIdle&gt;
    &lt;/dbConfig&gt;
</pre>


      <p>
      Explanation of the database configuration options.
      </p>
      <ul>
      <li>
      url: The URL of the database</li>
      <li>
      userName: The name of the database user</li>
      <li>
      password: The password of the database user</li>
      <li>
      driverName: The class name of the database driver</li>
      <li>
      maxActive: The maximum number of active connections that can be allocated from this pool at the same time, or negative for no limit.
      </li>
      <li>
      maxWait: The maximum number of milliseconds that the pool will wait (when there
          are no available connections) for a connection to be returned before throwing an
          exception, or &lt;= 0 to wait indefinitely. </li>
      <li>
      minIdle: The minimum number of active connections that can remain idle in the
          pool, without extra ones being created, or 0 to create none. </li>
      </ul>

      </li>
        <li>
          <p>
            Edit the  $GREG_HOME/repository/conf/user-mgt.xml file as below
            (Note that you have to replace these settings with your custom values).
          </p>

<pre>
    &lt;Configuration&gt;
        ...
        &lt;Property name="url"&gt;<strong>jdbc:h2:repository/database/WSO2CARBON_DB;DB_CLOSE_ON_EXIT=FALSE</strong>&lt;/Property&gt;
        &lt;Property name="userName"&gt;<strong>wso2carbon</strong>&lt;/Property&gt;
        &lt;Property name="password"&gt;<strong>wso2carbon</strong>&lt;/Property&gt;
        &lt;Property name="driverName"&gt;<strong>org.h2.Driver</strong>&lt;/Property&gt;
        &lt;Property name="maxActive"&gt;<strong>50</strong>&lt;/Property&gt;
        &lt;Property name="maxWait"&gt;<strong>60000</strong>&lt;/Property&gt;
        &lt;Property name="minIdle"&gt;<strong>5</strong>&lt;/Property&gt;
    &lt;/Configuration&gt;
</pre>
        </li>
      </ol>
<h2 id="drivers_embedded">Setup Drivers</h2>
Presently, H2 database version h2-1.2.140 and the related H2 database driver is shipped with WSO2 Governance Registry. If you wish to use a new H2 database driver other than the version shipped with the WSO2 Governance Registry, you need to do the following.
<ol>

    <li>
        <p>
	Delete H2 database related jars shipped with WSO2 Governance Registry. One could find them in the following locations.
	<pre>
    $GREG_HOME/repository/components/plugins/h2-database-engine-1.2.140.wso2v2.jar
    $GREG_HOME/repository/components/configuration/org.eclipse.osgi/bundles/38/1/.cp/h2-1.2.140.jar
    $GREG_HOME/repository/lib/h2-1.2.140.jar
    $GREG_HOME/lib/h2-database-engine-1.2.140.wso2v2.jar
	</pre>
        </p>
    </li>
    <li>  
        <p>
        Copy the new H2 database driver (org.h2.Driver) to $GREG_HOME/repository/components/lib. One could find the required driver jar in $H2_HOME/bin/h2-*.jar
    	</p>
   </li>
</ol>

      <h2 id="createdb_embedded">Create Database</h2>
      <h3 id="autodb_embedded">Automatic Database Creation</h3>
          <ol>
            <li>
              <p>
                Next at the first time you start the registry, run with the -Dsetup option, so
                it will create the H2 database with all the underlying tables.
              </p>

              <p>
                  sh wso2server.sh -Dsetup
              </p>
              <p>
                  wso2server.bat -Dsetup
              </p>
            </li>
       </ol>

      <h3 id="manualdb_embedded"> Manual Table Creation using scripts</h3>


      <ol>
          <li><p>Tables can be manually created by logging into created database and running  and following script in H2 shell or web console.</p>

          <p>
           GREG_HOME/dbscripts/h2.sql
          </p>

          </li>
          <li>
              <p>After setting up the registry DB tables. start the server with below commands.</p>

              <p>
                 sh wso2server.sh
              </p>
              <p>
                 wso2server.bat
              </p>
          </li>

      </ol>
</body>
</html>
